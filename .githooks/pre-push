#!/bin/bash
# Pre-push hook for AgentSpec

set -e

echo "üîç Running pre-push checks..."

# Run tests if they exist
if [ -f "pytest.ini" ] || [ -d "tests" ]; then
    echo "Running tests..."
    python3 -m pytest tests/ -v || echo "‚ö†Ô∏è  Tests failed or not configured"
fi

# Check CLI functionality
echo "Testing CLI functionality..."
if command -v agentspec >/dev/null 2>&1; then
    agentspec --help > /dev/null
    agentspec list-tags > /dev/null
    echo "‚úÖ CLI tests passed"
else
    echo "‚ö†Ô∏è  agentspec command not found in PATH, testing with python module..."
    python3 -c "from agentspec.cli.main import main; main(['--help'])" > /dev/null
    python3 -c "from agentspec.cli.main import main; main(['list-tags'])" > /dev/null
    echo "‚úÖ Module tests passed"
fi

# Test package build if build tools are available
if command -v python3 -m build >/dev/null 2>&1; then
    echo "Testing package build..."
    python3 -m build --wheel --outdir /tmp/agentspec-build-test/ > /dev/null 2>&1
    rm -rf /tmp/agentspec-build-test/
    echo "‚úÖ Package build test passed"
else
    echo "‚ö†Ô∏è  Build tools not available, skipping build test"
fi

# Check for security issues if bandit is available
if command -v bandit >/dev/null 2>&1; then
    echo "Running security checks..."
    bandit -r agentspec/ -ll || echo "‚ö†Ô∏è  Security check completed with warnings"
else
    echo "‚ö†Ô∏è  bandit not available, skipping security check"
fi

echo "‚úÖ All pre-push checks completed!"
